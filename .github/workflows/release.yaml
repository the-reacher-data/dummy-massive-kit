name: 🚀 Release Pipeline

on:
  push:
    branches: ["main"]

jobs:
  find-pr:
    runs-on: ubuntu-latest
    outputs:
      pr-number: ${{ steps.extract.outputs.pr-number }}
    steps:
      - name: Find PR number for this commit
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🔎 Searching PR for commit $GITHUB_SHA"
          pr_number=$(gh pr list \
            --repo ${{ github.repository }} \
            --state merged \
            --head ${{ github.ref_name }} \
            --json number \
            --jq '.[0].number')

          if [ -z "$pr_number" ]; then
            echo "❌ No PR found for commit $GITHUB_SHA"
            exit 1
          fi

          echo "✅ Found PR: $pr_number"
          echo "pr-number=$pr_number" >> $GITHUB_OUTPUT

  python-devops-releases:
    needs: find-pr
    uses: ./.github/workflows/python-release.yml
    with:
      python-version: "3.12"
      pypi-url: "https://upload.pypi.org/legacy/"
      pr-number: ${{ needs.find-pr.outputs.pr-number }}
    permissions:
      contents: read
      pull-requests: read
      id-token: write
      pages: write
      security-events: write
      actions: read

    secrets:
      pypi-secret: ${{ secrets.PYPI_API_TOKEN }}
      github-token: ${{ secrets.GITHUB_TOKEN }}
